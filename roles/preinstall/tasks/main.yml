- name: Set hostname
  become: true
  shell: hostname {{node_name}} && echo {{ node_name }} > /etc/hostname

- name: create apt repo variable
  become: true
  shell: echo "deb [allow-insecure=yes] http://10.140.79.120:8081/apt-repo ./" > /etc/apt/sources.list

- name: update the packages
  become: true
  shell: apt update -y

- name: Install socat for Ubuntu server
  become: true
  apt: name={{ item }} state=latest
  with_items:
  - socat
  allow-unauthenticated: yes

- name: Disable swap
  shell: swapoff -a

- name: Remove swap config from /etc/fstab
  lineinfile:
    path: /etc/fstab
    regexp: 'swap'
    state: absent
    backup: 'yes'

- name: Set hosts
  template: src=hosts.j2 dest=/etc/hosts

- name: Change sysctl config
  copy: src=k8s-sysctl.conf.j2 dest=/etc/sysctl.d/k8s-sysctl.conf

- name: Enable br_netfilter module
  modprobe: name=br_netfilter state=present
  ignore_errors: true
  
- name: Reload sysctl config
  shell: "sysctl -p /etc/sysctl.d/k8s-sysctl.conf"
  ignore_errors: true
